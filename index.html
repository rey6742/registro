<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti칩n Financiera Educativa (SGF-Edu)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1497294815431-9365093b7331?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px; 
            overflow-y: auto;
        }

        #mainCard {
            transition: all 0.3s ease-in-out;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
        }
        
        dialog {
            border: none;
            padding: 0;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgba(20, 4, 233, 0.25);
            max-width: 90%;
            width: 400px;
        }
        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
        }

        /* Loader para indicar carga de datos */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 5px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="mainCard" class="p-8 rounded-lg shadow-2xl w-full max-w-sm">
        <h1 id="mainTitle" class="text-3xl font-bold mb-6 text-gray-800 text-center">Gestion de Pagos y Mensualidades</h1>
        
        <form id="loginForm">
            <div class="mb-4">
                <label for="username" class="block text-gray-700 text-sm font-semibold mb-2">Nombre de Usuario</label>
                <input type="text" id="username" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="garcon" required>
            </div>
            
            <div class="mb-6">
                <label for="password" class="block text-gray-700 text-sm font-semibold mb-2">Contrase침a</label>
                <input type="password" id="password" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="*******" required>
            </div>
            
            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Iniciar Sesi칩n
            </button>
        </form>

        <div id="adminDashboard" class="hidden flex flex-col items-center gap-4">
            <p class="text-lg font-semibold text-gray-700 mb-2">Panel de Administraci칩n</p>
            
            <button id="btnMatricula" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-green-700 transition duration-300 shadow-md">
                Matr칤cula y Mensualidades (Estudiantes)
            </button>
            
            <button id="btnDocentes" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-md">
                Pagos de Docentes
            </button>
            
            <button id="logoutBtn" class="w-full mt-6 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                Cerrar Sesi칩n
            </button>
        </div>

        <div id="messageBox" class="mt-4 p-3 rounded-lg text-center hidden"></div>
    </div>

    <div id="matriculaDashboard" class="hidden absolute top-0 left-0 w-full min-h-screen pt-10 pb-10 flex justify-center items-start"></div>
    <div id="docentesDashboard" class="hidden absolute top-0 left-0 w-full min-h-screen pt-10 pb-10 flex justify-center items-start"></div>

    <dialog id="editModal">
        <div class="bg-white p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Editar Pago</h3>
            <form id="editPaymentForm" class="space-y-3">
                <input type="hidden" id="edit-firestore-id"> <input type="hidden" id="edit-display-id">   <input type="text" id="edit-matricula" placeholder="N춿 Matr칤cula" class="w-full px-3 py-2 border rounded-lg focus:ring-blue-500" required>
                <input type="text" id="edit-estudiante" placeholder="Estudiante" class="w-full px-3 py-2 border rounded-lg focus:ring-blue-500" required>
                <input type="text" id="edit-carrera" placeholder="Carrera" class="w-full px-3 py-2 border rounded-lg focus:ring-blue-500" required>
                <input type="text" id="edit-concepto" placeholder="Concepto" class="w-full px-3 py-2 border rounded-lg focus:ring-blue-500" required>
                <input type="number" id="edit-monto" placeholder="Monto (Bs.)" step="0.01" min="0" class="w-full px-3 py-2 border rounded-lg focus:ring-blue-500" required>
                <input type="date" id="edit-fecha" class="w-full px-3 py-2 border rounded-lg focus:ring-blue-500" required>
                
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" id="cancelEditBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </dialog>

    <dialog id="deleteModal">
        <div class="bg-white p-6 rounded-xl text-center">
            <svg class="w-12 h-12 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.398 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            <h3 class="text-lg font-bold text-gray-800">Confirmar Eliminaci칩n</h3>
            <p class="text-sm text-gray-600 mt-2">쮼st치s seguro de que deseas eliminar este registro? Esta acci칩n es **irreversible**.</p>
            <div class="flex justify-center gap-3 pt-6">
                <button id="cancelDeleteBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition">Cancelar</button>
                <button id="confirmDeleteBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">Eliminar</button>
            </div>
        </div>
    </dialog>

    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, addDoc, updateDoc, deleteDoc, query, where, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- TUS DATOS DE CONFIGURACI칍N ---
        const firebaseConfig = {
            apiKey: "AIzaSyDUTe-iQXbDyYe0CQJQCWMjwiOFazWMFZA",
            authDomain: "pruebapagos-5be44.firebaseapp.com",
            projectId: "pruebapagos-5be44",
            storageBucket: "pruebapagos-5be44.firebasestorage.app",
            messagingSenderId: "601576254486",
            appId: "1:601576254486:web:ef30d6b88bd860dac15937",
            measurementId: "G-0J08D8RMHH"
        };

        // Inicializar Firebase
        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase conectado correctamente");
        } catch (e) {
            console.error("Error conectando Firebase:", e);
            alert("Error conectando a la base de datos. Revisa la consola.");
        }

        // Cache global
        window.studentPayments = [];
        window.teacherPayments = [];

        // ==========================================
        // FUNCIONES FIREBASE (Asignadas a Window)
        // ==========================================

        window.fetchStudentPayments = async function() {
            if(!db) return;
            try {
                const q = query(collection(db, "payments"), orderBy("displayId", "desc"));
                const snapshot = await getDocs(q);
                window.studentPayments = [];
                snapshot.forEach(doc => window.studentPayments.push({ firestoreId: doc.id, ...doc.data() }));
                console.log("Pagos estudiantes cargados:", window.studentPayments.length);
            } catch(e) {
                console.error("Error leyendo pagos estudiantes. REGLAS DE FIREBASE ACTIVAS?", e);
            }
        }

        window.addStudentPayment = async function(data) {
            // Calcular nuevo ID num칠rico visual
            const maxId = window.studentPayments.length > 0 ? Math.max(...window.studentPayments.map(p => p.displayId || 0)) : 0;
            data.displayId = maxId + 1;
            await addDoc(collection(db, "payments"), data);
            await window.fetchStudentPayments();
        }

        window.updateStudentPayment = async function(firestoreId, data) {
            await updateDoc(doc(db, "payments", firestoreId), data);
            await window.fetchStudentPayments();
        }

        window.fetchTeacherPayments = async function() {
            if(!db) return;
            try {
                const q = query(collection(db, "teacher_payments"), orderBy("fecha", "desc"));
                const snapshot = await getDocs(q);
                window.teacherPayments = [];
                snapshot.forEach(doc => window.teacherPayments.push({ firestoreId: doc.id, ...doc.data() }));
            } catch(e) { console.error(e); }
        }

        window.addTeacherPayment = async function(data) {
            await addDoc(collection(db, "teacher_payments"), data);
            await window.fetchTeacherPayments();
        }
        
        window.deleteAnyPayment = async function(id, collectionName) {
            await deleteDoc(doc(db, collectionName, id));
            if(collectionName === "payments") await window.fetchStudentPayments();
            else await window.fetchTeacherPayments();
        }

        // Carga Inicial de Datos (Seed) si est치 vac칤a
        async function checkAndSeed() {
            if(!db) return;
            try {
                // Verificar estudiantes
                const stSnap = await getDocs(collection(db, "payments"));
                if (stSnap.empty) {
                    console.log("Base de datos vac칤a. Creando datos de ejemplo...");
                    const batch = writeBatch(db);
                    const initSt = [
                        { displayId: 1, matricula: '2023001', estudiante: 'Ana L칩pez', carrera: 'Psicolog칤a', concepto: 'Matr칤cula Anual', monto: 8300.00, fechaCancelacion: '2023-01-15' },
                        { displayId: 2, matricula: '2023002', estudiante: 'Roberto Soto', carrera: 'Ing. Sistemas', concepto: 'Mensualidad Marzo', monto: 1750.00, fechaCancelacion: '2023-03-05' },
                        { displayId: 3, matricula: '2023001', estudiante: 'Ana L칩pez', carrera: 'Psicolog칤a', concepto: 'Mensualidad Febrero', monto: 1750.00, fechaCancelacion: '2023-02-01' }
                    ];
                    initSt.forEach(p => batch.set(doc(collection(db, "payments")), p));
                    await batch.commit();
                    await window.fetchStudentPayments();
                } else {
                    await window.fetchStudentPayments();
                }

                // Verificar docentes
                const tcSnap = await getDocs(collection(db, "teacher_payments"));
                if (tcSnap.empty) {
                    const batch = writeBatch(db);
                    const initTc = [
                        { docente: 'Ing. Juan P칠rez', mes: 'Febrero', monto: 2500.00, fecha: '2023-02-28' },
                        { docente: 'Lic. Maria Rodriguez', mes: 'Marzo', monto: 2300.00, fecha: '2023-03-30' }
                    ];
                    initTc.forEach(p => batch.set(doc(collection(db, "teacher_payments")), p));
                    await batch.commit();
                    await window.fetchTeacherPayments();
                } else {
                    await window.fetchTeacherPayments();
                }
            } catch(e) {
                console.error("Error en Seed. Revisa permisos Firestore.", e);
            }
        }

        // Ejecutar carga inicial
        checkAndSeed();

        // ==========================================
        // L칍GICA DE INTERFAZ (UI)
        // ==========================================
        
        const LOGO_URL = "uploaded:FB_IMG_1757243137379.jpg-db84e9f9-5c79-46ec-9a97-abdeb0dca5b3";
        let base64Image = null;

        function getBase64Image(url, callback) {
            const img = new Image();
            img.crossOrigin = 'Anonymous'; 
            img.onload = function () {
                const canvas = document.createElement('canvas');
                canvas.width = this.naturalWidth;
                canvas.height = this.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(this, 0, this.naturalHeight, this.naturalWidth, -this.naturalHeight);
                base64Image = canvas.toDataURL('image/jpeg'); 
                callback();
            };
            img.onerror = () => { callback(); }
            img.src = url;
        }
        getBase64Image(LOGO_URL, () => {});

        // Elementos DOM
        const form = document.getElementById('loginForm');
        const mainCard = document.getElementById('mainCard');
        const adminDashboard = document.getElementById('adminDashboard');
        const matriculaDashboard = document.getElementById('matriculaDashboard');
        const docentesDashboard = document.getElementById('docentesDashboard');
        const messageBox = document.getElementById('messageBox');
        const mainTitle = document.getElementById('mainTitle');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Modales
        const editModal = document.getElementById('editModal');
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');

        let itemToDeleteId = null;
        let collectionToDelete = null;

        function hideAllViews() {
            form.classList.add('hidden');
            adminDashboard.classList.add('hidden');
            matriculaDashboard.classList.add('hidden');
            docentesDashboard.classList.add('hidden');
            messageBox.classList.add('hidden');
            mainCard.classList.remove('absolute', 'top-10', 'wide-card');
            mainCard.classList.add('max-w-sm');
        }

        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-200', 'text-red-700', 'bg-green-200', 'text-green-700');
            if (type === 'success') messageBox.classList.add('bg-green-200', 'text-green-700');
            else messageBox.classList.add('bg-red-200', 'text-red-700');
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 3000);
        }

        window.goBackToAdminPanel = function() {
            hideAllViews();
            mainCard.classList.remove('hidden');
            adminDashboard.classList.remove('hidden');
            mainTitle.textContent = 'Bienvenido, garcon';
            matriculaDashboard.innerHTML = '';
            docentesDashboard.innerHTML = '';
        }

        // PDF Helpers
        const drawHeaderAndWatermark = (doc, mainTitle, subTitle) => {
            const docWidth = doc.internal.pageSize.getWidth();
            const docHeight = doc.internal.pageSize.getHeight();
            const leftMargin = 14;

            if (base64Image) {
                const imgSize = docWidth * 0.7; 
                doc.setGState(new doc.GState({opacity: 0.1})); 
                doc.addImage(base64Image, 'JPEG', (docWidth - imgSize)/2, (docHeight - imgSize)/2, imgSize, imgSize);
                doc.setGState(new doc.GState({opacity: 1})); 
            }
            doc.setFontSize(12); doc.setFont(doc.getFont().fontName, 'bold');
            doc.text("ITS GARCON", leftMargin, 15); 
            doc.setFontSize(18);
            const textWidth = doc.getStringUnitWidth(mainTitle) * doc.getFontSize() / doc.internal.scaleFactor;
            doc.text(mainTitle, (docWidth - textWidth) / 2, 15);
            doc.setFontSize(10); doc.setFont(doc.getFont().fontName, 'normal');
            doc.text(subTitle, leftMargin, 23);
            return 30;
        };

        window.generatePaymentsPDF = function() {
            if (!window.jspdf) return alert('Librer칤a PDF cargando...');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const date = new Date().toLocaleDateString('es-ES');
            const data = window.studentPayments || [];
            const paymentsByStudent = data.reduce((acc, p) => {
                if (!acc[p.estudiante]) acc[p.estudiante] = [];
                acc[p.estudiante].push(p);
                return acc;
            }, {});

            let currentY = drawHeaderAndWatermark(doc, "DETALLES", `Reporte General - ${date}`);
            const leftMargin = 14;

            for (const student in paymentsByStudent) {
                const payments = paymentsByStudent[student];
                if (currentY + 20 > doc.internal.pageSize.getHeight() - 20) {
                    doc.addPage();
                    currentY = drawHeaderAndWatermark(doc, "DETALLES", `Reporte General - ${date}`);
                }
                doc.setFontSize(11); doc.setFont(doc.getFont().fontName, 'bold'); doc.setTextColor(0, 100, 0); 
                doc.text(`Estudiante: ${student} (Matr칤cula: ${payments[0].matricula})`, leftMargin, currentY);
                doc.setTextColor(0, 0, 0); currentY += 2; 

                doc.autoTable({
                    startY: currentY + 3,
                    head: [['Carrera', 'Concepto', 'Monto (Bs.)', 'Fecha', 'ID']],
                    body: payments.map(p => [p.carrera, p.concepto, `Bs.${p.monto.toFixed(2)}`, p.fechaCancelacion, p.displayId]),
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: { fillColor: [52, 152, 219], textColor: 255 },
                    margin: { left: leftMargin, right: 14 }
                });
                currentY = doc.lastAutoTable.finalY + 10;
            }
            doc.save(`Reporte_Pagos_${date.replace(/\//g,'-')}.pdf`);
        }

        window.generateReceiptPDF = function(index) {
            const payment = window.studentPayments[index];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const date = new Date().toLocaleDateString('es-ES');
            let currentY = drawHeaderAndWatermark(doc, "COMPROBANTE", `Pago N춿 ${payment.displayId}`);
            
            doc.setFontSize(11); doc.setFont(doc.getFont().fontName, 'bold');
            doc.text("DATOS DEL ESTUDIANTE", 14, currentY + 5);
            doc.setFont(doc.getFont().fontName, 'normal');
            doc.autoTable({
                startY: currentY + 8,
                body: [['Estudiante:', payment.estudiante], ['N춿 Matr칤cula:', payment.matricula], ['Carrera:', payment.carrera]],
                theme: 'plain', styles: { fontSize: 10, cellPadding: 1 },
                columnStyles: { 0: { fontStyle: 'bold', cellWidth: 35 } }, margin: { left: 14 }
            });
            currentY = doc.lastAutoTable.finalY + 8;
            doc.setFontSize(11); doc.setFont(doc.getFont().fontName, 'bold');
            doc.text("DETALLE DEL PAGO", 14, currentY);
            doc.autoTable({
                startY: currentY + 5,
                head: [['Concepto', 'Fecha', 'Monto']],
                body: [[payment.concepto, payment.fechaCancelacion, `Bs.${payment.monto.toFixed(2)}`]],
                headStyles: { fillColor: [52, 152, 219] },
                columnStyles: { 2: { fontStyle: 'bold', fillColor: [200, 230, 200] } }, margin: { left: 14, right: 14 }
            });
            doc.save(`Recibo_${payment.displayId}.pdf`);
        }

        // --- RENDERIZADO UI ---

        window.renderMatriculaDashboard = function() {
            matriculaDashboard.innerHTML = `
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-5xl wide-card">
                    <h2 class="text-3xl font-extrabold text-green-700 mb-6 text-center">Gesti칩n de Matr칤cula</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <button class="menu-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200" onclick="renderMatriculaContent('registroPago')"><span class="text-xl">游눯</span> Registrar Nuevo Pago</button>
                        <button class="menu-btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200" onclick="renderMatriculaContent('historialPagos')"><span class="text-xl">游늶</span> Historial de Pagos</button>
                        <button class="menu-btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200" onclick="renderMatriculaContent('pagosPendientes')"><span class="text-xl">游뚿</span> Pagos Pendientes</button>
                    </div>
                    <div id="matriculaContent" class="mt-8 border-t pt-6"><p class="text-gray-500 text-center">Selecciona una opci칩n.</p></div>
                    <button onclick="goBackToAdminPanel()" class="w-full mt-8 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-300">Volver al Panel Principal</button>
                </div>`;
        }

        window.renderMatriculaContent = async function(view) {
            const contentDiv = document.getElementById('matriculaContent');
            contentDiv.innerHTML = '<div class="text-center"><span class="loader"></span> Cargando datos...</div>';

            if(view === 'registroPago') {
                contentDiv.innerHTML = `
                    <h3 class="text-2xl font-semibold text-blue-700 mb-4 text-center">Registrar Nuevo Pago</h3>
                    <form id="registroPagoForm" class="space-y-4 max-w-md mx-auto">
                        <input type="text" placeholder="N춿 Matr칤cula" class="w-full px-4 py-2 border rounded-lg" required>
                        <input type="text" placeholder="Nombre estudiante" class="w-full px-4 py-2 border rounded-lg" required>
                        <input type="text" placeholder="Carrera" class="w-full px-4 py-2 border rounded-lg" required>
                        <input type="text" placeholder="Concepto" class="w-full px-4 py-2 border rounded-lg" required>
                        <input type="number" placeholder="Monto (Bs.)" step="0.01" class="w-full px-4 py-2 border rounded-lg" required>
                        <input type="date" class="w-full px-4 py-2 border rounded-lg" required>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">Guardar Pago</button>
                    </form>`;
                
                document.getElementById('registroPagoForm').onsubmit = async (e) => {
                    e.preventDefault();
                    if(window.addStudentPayment) {
                        const data = {
                            matricula: e.target[0].value, estudiante: e.target[1].value, carrera: e.target[2].value,
                            concepto: e.target[3].value, monto: parseFloat(e.target[4].value), fechaCancelacion: e.target[5].value
                        };
                        await window.addStudentPayment(data);
                        showMessage("Pago registrado", "success");
                        renderMatriculaContent('historialPagos');
                    }
                };
            } else if (view === 'historialPagos') {
                if(window.fetchStudentPayments) await window.fetchStudentPayments();
                const rows = window.studentPayments.map((p, index) => `
                    <tr class="hover:bg-green-50">
                        <td class="px-3 py-3 text-sm text-gray-900">${p.matricula}</td>
                        <td class="px-3 py-3 text-sm text-gray-900">${p.estudiante}</td>
                        <td class="px-3 py-3 text-sm text-gray-900">${p.carrera}</td>
                        <td class="px-3 py-3 text-sm text-gray-900">${p.concepto}</td>
                        <td class="px-3 py-3 text-sm font-semibold text-green-600">Bs.${p.monto.toFixed(2)}</td>
                        <td class="px-3 py-3 text-sm text-gray-500">${p.fechaCancelacion}</td>
                        <td class="px-3 py-3 text-right flex space-x-2 justify-center">
                            <button onclick="generateReceiptPDF(${index})" class="text-blue-600 hover:text-blue-800 font-medium p-1 rounded-full hover:bg-blue-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></button>
                            <button onclick="openEditModalFromIndex(${index})" class="text-yellow-600 hover:text-yellow-800 font-medium p-1 rounded-full hover:bg-yellow-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.879a2 2 0 012.828 0l1.414 1.414a2 2 0 010 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                            <button onclick="openDeleteModalFromId('${p.firestoreId}', 'payments')" class="text-red-600 hover:text-red-800 font-medium p-1 rounded-full hover:bg-red-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </td>
                    </tr>`).join('');

                contentDiv.innerHTML = `
                    <h3 class="text-2xl font-semibold text-green-700 mb-4 text-center">Historial de Pagos</h3>
                    <div class="flex justify-end mb-4 gap-3"><button onclick="generatePaymentsPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m4 0v3m0 0h2m-2 0h-2M15 11l-3-3-3 3"></path></svg>Reporte General PDF</button></div>
                    <div class="overflow-x-auto border rounded-lg shadow-inner"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-green-50"><tr><th class="px-3 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Matr칤cula</th><th class="px-3 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Estudiante</th><th class="px-3 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Carrera</th><th class="px-3 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Concepto</th><th class="px-3 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Monto</th><th class="px-3 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Fecha</th><th class="px-3 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Acciones</th></tr></thead><tbody class="bg-white divide-y divide-gray-100">${rows || '<tr><td colspan="7" class="text-center p-4">Sin datos</td></tr>'}</tbody></table></div>`;
            }
        }

        window.renderDocentesDashboard = function() {
            docentesDashboard.innerHTML = `
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-4xl wide-card">
                    <h2 class="text-3xl font-extrabold text-indigo-700 mb-6 text-center">Gesti칩n de Pagos a Docentes</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <button class="menu-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200" onclick="renderDocentesContent('registroPagoDocente')"><span class="text-xl">游눳</span> Registrar Pago Mensual</button>
                        <button class="menu-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200" onclick="renderDocentesContent('historialPagosDocente')"><span class="text-xl">游닄</span> Historial de Pagos</button>
                    </div>
                    <div id="docentesContent" class="mt-8 border-t pt-6"></div>
                    <button onclick="goBackToAdminPanel()" class="w-full mt-8 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-300">Volver al Panel Principal</button>
                </div>`;
        }

        window.renderDocentesContent = async function(view) {
            const contentDiv = document.getElementById('docentesContent');
            contentDiv.innerHTML = '<div class="text-center"><span class="loader"></span> Cargando...</div>';

            if(view === 'registroPagoDocente') {
                contentDiv.innerHTML = `
                    <h3 class="text-2xl font-semibold text-indigo-700 mb-4 text-center">Registrar Pago Docente</h3>
                    <form id="registroPagoDocenteForm" class="space-y-4 max-w-md mx-auto">
                        <input type="text" placeholder="Nombre Docente" class="w-full px-4 py-2 border rounded-lg" required>
                        <input type="text" placeholder="Mes" class="w-full px-4 py-2 border rounded-lg" required>
                        <input type="number" placeholder="Monto" step="0.01" class="w-full px-4 py-2 border rounded-lg" required>
                        <input type="date" class="w-full px-4 py-2 border rounded-lg" required>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg hover:bg-indigo-700">Guardar</button>
                    </form>`;
                document.getElementById('registroPagoDocenteForm').onsubmit = async (e) => {
                    e.preventDefault();
                    await window.addTeacherPayment({ docente: e.target[0].value, mes: e.target[1].value, monto: parseFloat(e.target[2].value), fecha: e.target[3].value });
                    showMessage("Pago docente guardado", "success");
                    renderDocentesContent('historialPagosDocente');
                };

            } else if (view === 'historialPagosDocente') {
                if(window.fetchTeacherPayments) await window.fetchTeacherPayments();
                const rows = window.teacherPayments.map((p) => `
                    <tr class="hover:bg-indigo-50">
                        <td class="px-3 py-3 text-sm">${p.docente}</td>
                        <td class="px-3 py-3 text-sm">${p.mes}</td>
                        <td class="px-3 py-3 text-sm font-bold text-indigo-600">Bs.${p.monto}</td>
                        <td class="px-3 py-3 text-sm">${p.fecha}</td>
                        <td class="px-3 py-3 text-center">
                            <button onclick="openDeleteModalFromId('${p.firestoreId}', 'teacher_payments')" class="text-red-600 hover:text-red-800 bg-red-100 p-1 rounded"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </td>
                    </tr>`).join('');
                contentDiv.innerHTML = `
                    <h3 class="text-2xl font-semibold text-indigo-700 mb-4 text-center">Historial Docentes</h3>
                    <div class="overflow-x-auto border rounded-lg"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-indigo-50"><tr><th class="px-3 py-3">Docente</th><th class="px-3 py-3">Mes</th><th class="px-3 py-3">Monto</th><th class="px-3 py-3">Fecha</th><th class="px-3 py-3 text-center">Acciones</th></tr></thead><tbody class="bg-white divide-y divide-gray-100">${rows || '<tr><td colspan="5" class="text-center p-4">Vac칤o</td></tr>'}</tbody></table></div>`;
            }
        }

        // --- MANEJO DE MODALES ---

        window.openEditModalFromIndex = function(index) {
            const p = window.studentPayments[index];
            document.getElementById('edit-firestore-id').value = p.firestoreId;
            document.getElementById('edit-display-id').value = p.displayId;
            document.getElementById('edit-matricula').value = p.matricula;
            document.getElementById('edit-estudiante').value = p.estudiante;
            document.getElementById('edit-carrera').value = p.carrera;
            document.getElementById('edit-concepto').value = p.concepto;
            document.getElementById('edit-monto').value = p.monto;
            document.getElementById('edit-fecha').value = p.fechaCancelacion;
            editModal.showModal();
        }

        document.getElementById('editPaymentForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-firestore-id').value;
            const data = {
                matricula: document.getElementById('edit-matricula').value,
                estudiante: document.getElementById('edit-estudiante').value,
                carrera: document.getElementById('edit-carrera').value,
                concepto: document.getElementById('edit-concepto').value,
                monto: parseFloat(document.getElementById('edit-monto').value),
                fechaCancelacion: document.getElementById('edit-fecha').value
            };
            if(window.updateStudentPayment) {
                await window.updateStudentPayment(id, data);
                editModal.close();
                showMessage("Pago actualizado", "success");
                renderMatriculaContent('historialPagos');
            }
        };
        cancelEditBtn.onclick = () => editModal.close();

        window.openDeleteModalFromId = function(id, collection) {
            itemToDeleteId = id;
            collectionToDelete = collection;
            deleteModal.showModal();
        }

        confirmDeleteBtn.onclick = async () => {
            if (itemToDeleteId && collectionToDelete) {
                await window.deleteAnyPayment(itemToDeleteId, collectionToDelete);
                deleteModal.close();
                showMessage("Registro eliminado", "success");
                if (collectionToDelete === 'payments') renderMatriculaContent('historialPagos');
                else renderDocentesContent('historialPagosDocente');
            }
        };
        cancelDeleteBtn.onclick = () => deleteModal.close();

        // --- NAVEGACION LOGIN ---
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (username === 'garcon' && password === '12345678') {
                showMessage('춰Ingreso exitoso!', 'success');
                hideAllViews();
                adminDashboard.classList.remove('hidden');
                mainTitle.textContent = 'Bienvenido, garcon';
                form.classList.add('hidden');
                mainCard.classList.remove('max-w-sm');
                mainCard.classList.add('max-w-md');
                mainCard.style.backgroundColor = 'white';
                if(window.fetchStudentPayments) window.fetchStudentPayments();
            } else {
                showMessage('Credenciales incorrectas.', 'error');
            }
        });

        logoutBtn.addEventListener('click', () => {
            hideAllViews();
            form.classList.remove('hidden');
            mainTitle.textContent = 'Ingreso al Sistema';
            document.getElementById('password').value = '';
            mainCard.classList.remove('max-w-md');
            mainCard.classList.add('max-w-sm');
            mainCard.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        });

        document.getElementById('btnMatricula').onclick = () => { hideAllViews(); matriculaDashboard.classList.remove('hidden'); renderMatriculaDashboard(); };
        document.getElementById('btnDocentes').onclick = () => { hideAllViews(); docentesDashboard.classList.remove('hidden'); renderDocentesDashboard(); };

    </script>
</body>
</html>